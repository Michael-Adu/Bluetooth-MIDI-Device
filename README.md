# Michael Adu - MIDI Device Project

# System Proposal

Using a Nucleo F446RE, this program allows for a Bluetooth device to send a note to the development board connected to a speaker. The board proceeds to play the note. This project is accompanied by a flutter application for increased ease of use. This program was written using the Mbed framework version 6.16.0.

Upon the user connecting their phone device to the Bluetooth module, the user should be able to hear the corresponding note to the key pressed on either the piano or drum. If the user hears the note, then the program runs successfully.

# Hardware Design

The hardware used for the program are as follows:

## Nucleo F44RE

Housing an STM32 micrcontroller, this development board is commonly used in prototyping with arduino headers. It is programmed with C/C++ in either CMSIS mode or using the Mbed OS. The development board is connected to the bluetooth module via its TX/RX pins as well as the speaker via one of its analog pins.

## HC-05 Bluetooth Module

The module is used to establish a connection with another bluetooth device for exchange of information between the development board and the bluetooth device. This is done via the UART serial and is powered by 5V.

## Speaker Module

The speaker module is responsible for outputting the signal generated by the Nucleo F44RE.

The schematic is shown below.

![Final Project_schem.svg](Michael%20Adu%20-%20MIDI%20Device%20Project%209656cfcbe0344d25be5113417ae4c404/Final_Project_schem.svg)

# Embedded Code Implementation and Architecture

The embedded program is structured around timers, tickers and interrupts. The program can be split into the following compartments:

- Timers and Tickers
    - Using a single timer, three different tickers are created to fulfil various purposes.
    
    ```cpp
    Timer tim;
    Ticker tic;
    Ticker amplitudeReduce;
    Ticker amplitudeDieDown;
    ```
    
    - The `tic` Ticker is used to continuously write the selected frequency signal to the speaker. It is initialized in the `main` function
    
    ```cpp
    int main()
    {
      tim.start();
      bluetooth.sigio(&on_rx_interrupt);
      tic.attach_us(&DAC_Int, 1000000 / DAC_Frequency);
      while (1)
      {
      }
    }
    
    void DAC_Int(void)
    {
      signalCalculate(freq);
      dac.write(outputSignal[0]);
    }
    ```
    
- Signal Generation
    - To generate the signal corresponding to the tone, the following function uses the current tic position to send a continuous signal to the analog output.
    
    ```cpp
    void signalCalculate(int frequency)
    {
      int period = 1000000 / freq;
      int pos = tim.read_us() % period;
      outputSignal[keyNum] = amplitude * (sin((pos * 3.14f * 2 / period)));
    }
    ```
    
- Creating a class for the music keys
    - To organise the data for referencing, a custom class was created called MusicKey. This class contains the music key as a string and its corresponding frequency as an integer.
    
    ```cpp
    class MusicKey
    {
    public:
      std::string key;
      int frequency;
      MusicKey(std::string myKey, int myFrequency);
    };
    MusicKey::MusicKey(std::string myKey, int myFrequency) : key(myKey), frequency(myFrequency){};
    ```
    
- Serial Communication
    - Using BufferedSerial, the bluetooth module can trigger a callback function upon receiving a character from the connected device as an interrupt routine.
    
    ```cpp
    BufferedSerial bluetooth(D8, D2, 9600);
    bluetooth.sigio(&on_rx_interrupt);
    ```
    
    - The callback function acts as a buffer to receive the full note, as the serial class read function only reads a single character at a time reliably. Upon receiving the full note, it is referenced against the MusicKey array and assigns the frequency to be played by the speaker.
    - The callback function also triggers an amplitude decay function depending on if the received key is a piano key or drum key.
    
    ```cpp
    void on_rx_interrupt()
    {
      char c;
      if (bluetooth.readable())
      {
        bluetooth.read(&c, 1);
        char *token;
        token = strtok(&c, "^@");
        if (token != NULL)
        {
          note.append(token);
    
          if (note.length() == 3)
          {
            char play = 'p';
            if (note.find("p") != std::string::npos)
            {
    
              for (int j = 0; j < 31; j++)
              {
                if (keys[j].key == note.substr(0, 2).c_str())
                {
                  amplitude = 1;
                  if (j < (31 - 6))
                  {
                    amplitudeReduce.attach_us(&reduceAmp, 200000);
                  }
                  else
                  {
                    amplitudeDieDown.attach_us(&dieDown, 10000);
                  }
                  freq = keys[j].frequency;
                  bluetooth.write(note.c_str(), 3);
                  note.clear();
                }
              }
            }
            if (note.find(";") != std::string::npos)
            {
              bluetooth.write(note.c_str(), 3);
              note.clear();
            }
          }
        }
      }
    }
    
    void reduceAmp()
    {
      amplitude = amplitude - 0.1;
      if (amplitude < 0.45)
      {
        amplitudeDieDown.attach_us(&dieDown, 130000);
        amplitudeReduce.detach();
      }
    }
    
    void dieDown()
    {
      amplitude = amplitude - 0.05;
      if (amplitude < 0)
      {
        amplitudeDieDown.detach();
      }
    }
    ```
    

# Mobile Application

The mobile application was created in flutter and can be installed from the `apk-debug.apk` file on android devices.

![Home Screen](Michael%20Adu%20-%20MIDI%20Device%20Project%209656cfcbe0344d25be5113417ae4c404/Untitled.png)

Home Screen

![Piano](Michael%20Adu%20-%20MIDI%20Device%20Project%209656cfcbe0344d25be5113417ae4c404/Untitled%201.png)

Piano

![DrumPad](Michael%20Adu%20-%20MIDI%20Device%20Project%209656cfcbe0344d25be5113417ae4c404/Untitled%202.png)

DrumPad

![Bluetooth Discovery and Selection](Michael%20Adu%20-%20MIDI%20Device%20Project%209656cfcbe0344d25be5113417ae4c404/Untitled%203.png)

Bluetooth Discovery and Selection

# Final Evaluation

The application works as initially intended, with the tones sent from the user being played as intended. However, due to current limitations the ability to play chords (multiple keys at once to create a harmonious sound) could not be implemented.
